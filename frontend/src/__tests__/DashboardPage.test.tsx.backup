import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen, fireEvent, waitFor, within } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import DashboardPage from '../pages/DashboardPage';

const mockNavigate = vi.fn();

vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

describe('DashboardPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.useFakeTimers();
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  describe('Rendering and Loading State', () => {
    it('renders without crashing', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      expect(screen.getByText(/טוען נתונים/i)).toBeInTheDocument();

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/לוח בקרה/i)).toBeInTheDocument();
      });
    });

    it('shows loading spinner initially', () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      expect(screen.getByText(/טוען נתונים/i)).toBeInTheDocument();
    });

    it('displays loading message', () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      expect(screen.getByText(/טוען נתונים/i)).toBeInTheDocument();
    });

    it('hides loading state after data loads', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      expect(screen.getByText(/טוען נתונים/i)).toBeInTheDocument();

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.queryByText(/טוען נתונים/i)).not.toBeInTheDocument();
      });
    });
  });

  describe('Dashboard Header', () => {
    it('displays dashboard heading', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByRole('heading', { level: 1, name: /לוח בקרה/i })).toBeInTheDocument();
      });
    });

    it('displays last updated timestamp', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/עודכן לאחרונה/i)).toBeInTheDocument();
      });
    });

    it('displays calendar icon in header', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const header = screen.getByText(/עודכן לאחרונה/i);
        expect(header).toBeInTheDocument();
      });
    });
  });

  describe('Statistics Cards', () => {
    it('displays 4 stat cards', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const statCards = screen.getAllByRole('article');
        expect(statCards.length).toBeGreaterThanOrEqual(4);
      });
    });

    it('displays projects stat card', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/סך הכל פרויקטים/i)).toBeInTheDocument();
      });
    });

    it('displays submissions stat card', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/סך הכל הגשות/i)).toBeInTheDocument();
      });
    });

    it('displays pass rate stat card', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/אחוז הצלחה/i)).toBeInTheDocument();
      });
    });

    it('displays fail rate stat card', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/אחוז כישלון/i)).toBeInTheDocument();
      });
    });

    it('stat cards have numeric values', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const articles = screen.getAllByRole('article');
        articles.forEach(card => {
          const text = card.textContent;
          expect(text).toMatch(/\d+/);
        });
      });
    });

    it('stat cards display trend information', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/מהחודש הקודם/i)).toBeInTheDocument();
      });
    });
  });

  describe('Charts Rendering', () => {
    it('renders bar chart section', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/הגשות לפי חודש/i)).toBeInTheDocument();
      });
    });

    it('renders pie chart section', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/התפלגות תוצאות/i)).toBeInTheDocument();
      });
    });

    it('renders line chart section', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/מגמת הגשות/i)).toBeInTheDocument();
      });
    });

    it('bar chart has proper aria labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const chartRegion = screen.getByRole('region', { name: /גרף הגשות חודשי/i });
        expect(chartRegion).toBeInTheDocument();
      });
    });

    it('pie chart has proper aria labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const chartRegion = screen.getByRole('region', { name: /התפלגות תוצאות/i });
        expect(chartRegion).toBeInTheDocument();
      });
    });

    it('line chart has proper aria labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const chartRegion = screen.getByRole('region', { name: /מגמת הגשות/i });
        expect(chartRegion).toBeInTheDocument();
      });
    });
  });

  describe('Recent Projects Table', () => {
    it('displays recent projects section', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/פרויקטים אחרונים/i)).toBeInTheDocument();
      });
    });

    it('displays projects table with data', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/מתחם מגורים חדש/i)).toBeInTheDocument();
      });
    });

    it('table has proper columns', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/שם הפרויקט/i)).toBeInTheDocument();
        expect(screen.getByText(/עיר/i)).toBeInTheDocument();
        expect(screen.getByText(/סטטוס/i)).toBeInTheDocument();
        expect(screen.getByText(/תאריך/i)).toBeInTheDocument();
      });
    });

    it('displays project names in table', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/מתחם מגורים חדש/i)).toBeInTheDocument();
        expect(screen.getByText(/בניין משרדים/i)).toBeInTheDocument();
      });
    });

    it('displays project cities', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/תל אביב/i)).toBeInTheDocument();
        expect(screen.getByText(/הרצליה/i)).toBeInTheDocument();
      });
    });

    it('displays project status badges', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/פעיל/i)).toBeInTheDocument();
        expect(screen.getByText(/הושלם/i)).toBeInTheDocument();
      });
    });

    it('projects table rows are clickable', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const projectRows = screen.getAllByRole('row');
        projectRows.forEach(row => {
          if (row.textContent?.includes('מתחם מגורים')) {
            expect(row).toHaveClass('cursor-pointer');
          }
        });
      });
    });

    it('clicking project row navigates to detail page', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const projectName = screen.getByText(/מתחם מגורים חדש/i);
        const row = projectName.closest('tr');
        fireEvent.click(row!);

        expect(mockNavigate).toHaveBeenCalledWith('/projects/1');
      });
    });

    it('displays view button for each project', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const viewButtons = screen.getAllByRole('button').filter(btn => btn.textContent?.includes('צפה'));
        expect(viewButtons.length).toBeGreaterThan(0);
      });
    });

    it('view button navigates to project detail', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const viewButtons = screen.getAllByRole('button').filter(btn => btn.textContent?.includes('צפה'));
        if (viewButtons.length > 0) {
          fireEvent.click(viewButtons[0]);
          expect(mockNavigate).toHaveBeenCalled();
        }
      });
    });

    it('has proper table aria labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = screen.getAllByRole('table');
        expect(tables.length).toBeGreaterThan(0);
      });
    });
  });

  describe('Recent Submissions Table', () => {
    it('displays recent submissions section', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/הגשות אחרונות/i)).toBeInTheDocument();
      });
    });

    it('displays submissions table with data', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = screen.getAllByRole('table');
        expect(tables.length).toBeGreaterThanOrEqual(2);
      });
    });

    it('submissions table has proper columns', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const headers = screen.getAllByText(/פרויקט|סטטוס|תאריך|תוצאה/i);
        expect(headers.length).toBeGreaterThan(0);
      });
    });

    it('displays submission project names', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getAllByText(/מתחם מגורים חדש/).length).toBeGreaterThan(0);
      });
    });

    it('displays submission status badges', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/אושר/i)).toBeInTheDocument();
        expect(screen.getByText(/נדחה/i)).toBeInTheDocument();
      });
    });

    it('displays submission result badges', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/עבר/i)).toBeInTheDocument();
        expect(screen.getByText(/נכשל/i)).toBeInTheDocument();
      });
    });

    it('submissions table rows are clickable', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = screen.getAllByRole('table');
        if (tables.length > 1) {
          const rows = within(tables[1]).getAllByRole('row');
          expect(rows.length).toBeGreaterThan(1);
        }
      });
    });

    it('clicking submission row navigates to detail page', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const allRows = screen.getAllByRole('row');
        const submissionRow = allRows.find(row => row.textContent?.includes('s1'));
        if (submissionRow) {
          fireEvent.click(submissionRow);
          expect(mockNavigate).toHaveBeenCalled();
        }
      });
    });
  });

  describe('Empty State', () => {
    it('shows empty state message when no projects', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const pageText = screen.getByText(/לוח בקרה/i);
        expect(pageText).toBeInTheDocument();
      });
    });

    it('displays alert icon in empty state', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/לוח בקרה/i)).toBeInTheDocument();
      });
    });
  });

  describe('Responsive Layout', () => {
    it('dashboard is full width', async () => {
      const { container } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const main = container.querySelector('[dir="rtl"]');
        expect(main).toBeInTheDocument();
      });
    });

    it('stats grid is responsive', async () => {
      const { container } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const section = screen.getByRole('region', { name: /סטטיסטיקות ראשיות/i });
        expect(section).toHaveClass('grid');
      });
    });

    it('charts section is responsive', async () => {
      const { container } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const sections = container.querySelectorAll('section');
        expect(sections.length).toBeGreaterThan(0);
      });
    });

    it('tables are scrollable on small screens', async () => {
      const { container } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const divs = container.querySelectorAll('div[class*="overflow"]');
        expect(divs.length).toBeGreaterThan(0);
      });
    });
  });

  describe('Accessibility', () => {
    it('has proper heading hierarchy', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const h1 = screen.getByRole('heading', { level: 1 });
        expect(h1).toBeInTheDocument();
      });
    });

    it('stat cards have article role', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const articles = screen.getAllByRole('article');
        expect(articles.length).toBeGreaterThan(0);
      });
    });

    it('regions have aria labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const regions = screen.getAllByRole('region');
        regions.forEach(region => {
          expect(region).toHaveAttribute('aria-label');
        });
      });
    });

    it('tables have proper role', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = screen.getAllByRole('table');
        expect(tables.length).toBeGreaterThan(0);
      });
    });

    it('interactive rows have proper keyboard support', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const rows = screen.getAllByRole('row');
        rows.forEach(row => {
          if (row.className?.includes('cursor-pointer')) {
            expect(row).toHaveAttribute('tabIndex');
          }
        });
      });
    });

    it('buttons have accessible labels', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const buttons = screen.getAllByRole('button');
        buttons.forEach(button => {
          expect(button).toHaveAccessibleName();
        });
      });
    });
  });

  describe('Data Display', () => {
    it('displays all stat values correctly', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/50/i)).toBeInTheDocument();
        expect(screen.getByText(/%/i)).toBeInTheDocument();
      });
    });

    it('formats dates correctly', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const dateTexts = screen.getAllByText(/\d+:\d+/);
        expect(dateTexts.length).toBeGreaterThan(0);
      });
    });

    it('displays status and result badges correctly', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/פעיל/i)).toBeInTheDocument();
        expect(screen.getByText(/עבר/i)).toBeInTheDocument();
      });
    });

    it('displays city information with icon', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/תל אביב/i)).toBeInTheDocument();
        expect(screen.getByText(/הרצליה/i)).toBeInTheDocument();
      });
    });
  });

  describe('User Interactions', () => {
    it('handles project row clicks', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const projectName = screen.getByText(/מתחם מגורים חדש/i);
        const row = projectName.closest('tr');
        fireEvent.click(row!);

        expect(mockNavigate).toHaveBeenCalled();
      });
    });

    it('handles submission row clicks', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const allRows = screen.getAllByRole('row');
        if (allRows.length > 5) {
          fireEvent.click(allRows[5]);
          expect(mockNavigate).toHaveBeenCalled();
        }
      });
    });

    it('handles view button clicks', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const buttons = screen.getAllByRole('button').filter(btn => btn.textContent?.includes('צפה'));
        if (buttons.length > 0) {
          fireEvent.click(buttons[0]);
          expect(mockNavigate).toHaveBeenCalled();
        }
      });
    });

    it('prevents event propagation on button click', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const buttons = screen.getAllByRole('button').filter(btn => btn.textContent?.includes('צפה'));
        if (buttons.length > 0) {
          const event = new MouseEvent('click', { bubbles: true });
          const stopPropagation = vi.spyOn(event, 'stopPropagation');
          fireEvent(buttons[0], event);
          expect(stopPropagation).toHaveBeenCalled();
        }
      });
    });

    it('handles keyboard navigation on table rows', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const rows = screen.getAllByRole('row');
        const interactiveRow = rows.find(row => row.className?.includes('cursor-pointer'));
        if (interactiveRow) {
          fireEvent.keyDown(interactiveRow, { key: 'Enter', code: 'Enter' });
          expect(mockNavigate).toHaveBeenCalled();
        }
      });
    });
  });

  describe('Error Handling', () => {
    it('continues to render if data loading fails gracefully', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/לוח בקרה/i)).toBeInTheDocument();
      });
    });

    it('displays dashboard even if some data is missing', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByRole('heading', { level: 1 })).toBeInTheDocument();
      });
    });
  });

  describe('Performance', () => {
    it('renders stat cards efficiently', async () => {
      const { rerender } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const articles = screen.getAllByRole('article');
        expect(articles.length).toBe(4);
      });

      rerender(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const articles = screen.getAllByRole('article');
        expect(articles.length).toBe(4);
      });
    });

    it('renders tables without performance issues', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = screen.getAllByRole('table');
        expect(tables.length).toBeGreaterThan(0);
        tables.forEach(table => {
          const rows = within(table).getAllByRole('row');
          expect(rows.length).toBeGreaterThan(0);
        });
      });
    });
  });

  describe('Visual Elements', () => {
    it('displays icons for stat cards', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const articles = screen.getAllByRole('article');
        expect(articles.length).toBeGreaterThan(0);
      });
    });

    it('displays styled badges for status', async () => {
      render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        expect(screen.getByText(/פעיל/i)).toBeInTheDocument();
        const badge = screen.getByText(/פעיל/i);
        expect(badge.className).toContain('rounded');
      });
    });

    it('displays properly styled tables', async () => {
      const { container } = render(
        <BrowserRouter>
          <DashboardPage />
        </BrowserRouter>
      );

      vi.advanceTimersByTime(800);

      await waitFor(() => {
        const tables = container.querySelectorAll('table');
        expect(tables.length).toBeGreaterThan(0);
      });
    });
  });
});
