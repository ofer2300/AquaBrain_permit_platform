import { describe, it, expect, beforeEach, vi } from 'vitest';
import { render, screen, fireEvent, waitFor, within } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import HomePage from '../pages/HomePage';

const mockNavigate = vi.fn();

vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

describe('HomePage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('Rendering', () => {
    it('renders without crashing', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      expect(screen.getByText(/Building Permit Platform/i)).toBeInTheDocument();
    });

    it('displays the main heading', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const heading = screen.getByRole('heading', { level: 2, name: /הפלטפורמה החכמה להרשאות בנייה/i });
      expect(heading).toBeInTheDocument();
    });

    it('displays the main description text', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      expect(screen.getByText(/שימוש בטכנולוגיית AI/i)).toBeInTheDocument();
    });

    it('renders footer with copyright', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      expect(screen.getByText(/כל הזכויות שמורות/i)).toBeInTheDocument();
    });

    it('renders all feature sections', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      expect(screen.getByText('עיבוד מהיר')).toBeInTheDocument();
      expect(screen.getByText('ניתוח חכם')).toBeInTheDocument();
      expect(screen.getByText('ציות מובטח')).toBeInTheDocument();
      expect(screen.getByText('שקיפות מלאה')).toBeInTheDocument();
    });
  });

  describe('Navigation Links', () => {
    it('renders navigation links in header', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const loginLink = screen.getByRole('link', { name: /כניסה/i });
      const registerLink = screen.getByRole('link', { name: /הרשמה/i });
      expect(loginLink).toBeInTheDocument();
      expect(registerLink).toBeInTheDocument();
    });

    it('login link has correct href', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const loginLink = screen.getByRole('link', { name: /כניסה/i });
      expect(loginLink).toHaveAttribute('href', '/login');
    });

    it('register link has correct href', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const registerLink = screen.getByRole('link', { name: /הרשמה/i });
      expect(registerLink).toHaveAttribute('href', '/register');
    });

    it('links are clickable', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const loginLink = screen.getByRole('link', { name: /כניסה/i });
      expect(loginLink).not.toHaveAttribute('disabled');
    });
  });

  describe('Get Started Button', () => {
    it('has Get Started button on page', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });
      expect(buttons.length).toBeGreaterThan(0);
    });

    it('Get Started button is visible and clickable', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });
      buttons.forEach(button => {
        expect(button).toBeVisible();
        expect(button).not.toHaveAttribute('disabled');
      });
    });

    it('Get Started button navigates to login on click', async () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });

      fireEvent.click(buttons[0]);

      await waitFor(() => {
        expect(mockNavigate).toHaveBeenCalledWith('/login');
      });
    });

    it('multiple Get Started buttons navigate to login', async () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });

      for (let i = 0; i < buttons.length; i++) {
        fireEvent.click(buttons[i]);
      }

      await waitFor(() => {
        expect(mockNavigate).toHaveBeenCalledWith('/login');
      });
    });
  });

  describe('Feature Section', () => {
    it('renders features region with correct aria label', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      expect(screen.getByRole('region', { name: /תכונות הפלטפורמה/i })).toBeInTheDocument();
    });

    it('displays 4 feature cards', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );
      const articles = screen.getAllByRole('article');
      expect(articles).toHaveLength(4);
    });

    it('each feature card has title and description', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const featureData = [
        { title: 'עיבוד מהיר', desc: 'עיבוד בקשות הרשאות בנייה בדקות' },
        { title: 'ניתוח חכם', desc: 'בדיקה אוטומטית של תקנות' },
        { title: 'ציות מובטח', desc: 'הבטח ציות מלא לתקנות' },
        { title: 'שקיפות מלאה', desc: 'עקוב אחר מצב בקשתך' }
      ];

      featureData.forEach(feature => {
        expect(screen.getByText(feature.title)).toBeInTheDocument();
        expect(screen.getByText(new RegExp(feature.desc))).toBeInTheDocument();
      });
    });
  });

  describe('Responsive Layout', () => {
    it('renders heading at various screen sizes', () => {
      const { rerender } = render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByRole('heading', { level: 2 })).toBeInTheDocument();

      rerender(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByRole('heading', { level: 2 })).toBeInTheDocument();
    });

    it('main content is wrapped in proper semantic HTML', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByRole('main')).toBeInTheDocument();
    });

    it('navigation is properly structured', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const nav = screen.getByRole('navigation', { hidden: true });
      expect(nav).toBeInTheDocument();
    });

    it('all sections are visible in viewport', () => {
      const { container } = render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const sections = container.querySelectorAll('section');
      expect(sections.length).toBeGreaterThan(0);
    });
  });

  describe('Accessibility', () => {
    it('has proper heading hierarchy', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const h1 = screen.queryByRole('heading', { level: 1 });
      const h3 = screen.getByRole('heading', { level: 3 });

      expect(h3).toBeInTheDocument();
    });

    it('all buttons have proper labels', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });
      buttons.forEach(button => {
        expect(button).toHaveAccessibleName();
      });
    });

    it('region has aria-label for features', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const region = screen.getByRole('region', { name: /תכונות הפלטפורמה/i });
      expect(region).toHaveAttribute('aria-label');
    });

    it('all articles have semantic role', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const articles = screen.getAllByRole('article');
      articles.forEach(article => {
        expect(article).toBeInTheDocument();
      });
    });
  });

  describe('Visual Elements', () => {
    it('renders all feature titles', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByText('עיבוד מהיר')).toBeInTheDocument();
      expect(screen.getByText('ניתוח חכם')).toBeInTheDocument();
      expect(screen.getByText('ציות מובטח')).toBeInTheDocument();
      expect(screen.getByText('שקיפות מלאה')).toBeInTheDocument();
    });

    it('renders call-to-action section', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByText(/מוכן להתחיל/i)).toBeInTheDocument();
    });

    it('call-to-action section includes description', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByText(/הצטרף לאלפים/i)).toBeInTheDocument();
    });

    it('renders footer section', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const footer = screen.getByText(/כל הזכויות שמורות/i);
      expect(footer).toBeInTheDocument();
    });
  });

  describe('User Interactions', () => {
    it('buttons are keyboard accessible', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });
      buttons.forEach(button => {
        expect(button).toBeVisible();
        fireEvent.keyDown(button, { key: 'Enter', code: 'Enter' });
      });
    });

    it('links are keyboard accessible', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const links = screen.getAllByRole('link');
      links.forEach(link => {
        expect(link).toBeVisible();
      });
    });

    it('handles multiple button clicks', async () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });

      fireEvent.click(buttons[0]);
      fireEvent.click(buttons[0]);

      await waitFor(() => {
        expect(mockNavigate).toHaveBeenCalled();
      });
    });

    it('does not navigate on disabled state', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });
      const disabledButtons = buttons.filter(btn => btn.hasAttribute('disabled'));

      disabledButtons.forEach(btn => {
        fireEvent.click(btn);
      });

      expect(mockNavigate).not.toHaveBeenCalled();
    });
  });

  describe('Content Completeness', () => {
    it('has logo/brand name', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByText(/Building Permit Platform/i)).toBeInTheDocument();
    });

    it('has primary heading', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByRole('heading', { level: 2 })).toBeInTheDocument();
    });

    it('has secondary heading', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByRole('heading', { level: 3 })).toBeInTheDocument();
    });

    it('all feature descriptions are present', () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      expect(screen.getByText(/עיבוד בקשות הרשאות בנייה בדקות/i)).toBeInTheDocument();
      expect(screen.getByText(/בדיקה אוטומטית של תקנות/i)).toBeInTheDocument();
      expect(screen.getByText(/הבטח ציות מלא/i)).toBeInTheDocument();
      expect(screen.getByText(/עקוב אחר מצב בקשתך/i)).toBeInTheDocument();
    });
  });

  describe('State Management', () => {
    it('maintains navigation state across renders', async () => {
      const { rerender } = render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const button = screen.getAllByRole('button', { name: /התחל עכשיו/i })[0];
      fireEvent.click(button);

      rerender(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      await waitFor(() => {
        expect(mockNavigate).toHaveBeenCalledWith('/login');
      });
    });

    it('all buttons work after initial render', async () => {
      render(
        <BrowserRouter>
          <HomePage />
        </BrowserRouter>
      );

      const buttons = screen.getAllByRole('button', { name: /התחל עכשיו/i });

      for (const button of buttons) {
        fireEvent.click(button);
        expect(mockNavigate).toHaveBeenCalledWith('/login');
      }
    });
  });
});
